<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Profile</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="MainStyle.css">
    <script>
        $(document).ready(function () {
            let allUserReservations = [];
            let allUserFlights = [];
            let currentUser = null;

            function loadProfile() {
                $.ajax({
                    url: '/api/users/currentuser',
                    method: 'GET',
                    success: function (user) {
                        currentUser = user;
                        document.title = `${user.username}'s Profile`;
                        $('#profileTitle').text(`${user.username} (${user.firstName} ${user.lastName})`);
                        $('#email').text(`Email: ${user.email}`);
                        $('#dob').text(`Date of Birth: ${user.dateOfBirth}`);
                        $('#gender').text(`Gender: ${user.gender}`);
                        $('#type').text(`User type: ${user.userType}`);
                        $('#profileInfo').show();
                        $('#loadingMessage').hide();

                        $('#editUsername').val(user.username);
                        $('#editUsername').attr('data-current-username', user.username);
                        $('#editPassword').val(user.password);
                        $('#editFirstName').val(user.firstName);
                        $('#editLastName').val(user.lastName);
                        $('#editEmail').val(user.email);
                        $('#editDateOfBirth').val(user.dateOfBirth);
                        $('input[name="editGender"][value="' + user.gender + '"]').prop('checked', true);

                        if (user.userType === 'Traveler') {
                            allUserReservations = user.reservations;
                            allUserFlights = extractFlightsFromReservations(allUserReservations);
                            displayFlights(allUserFlights);
                            displayReservations(allUserReservations);
                        }
                    },
                    error: function (xhr) {
                        console.error(`Failed to load profile: ${xhr.responseText}`);
                        window.location.href = 'Login.html';
                    }
                });
            }

            function extractFlightsFromReservations(reservations) {
                const filteredReservations = reservations.filter(reservation =>
                    reservation.status === 'Created' ||
                    reservation.status === 'Approved' ||
                    reservation.status === 'Completed'
                );
                const flights = filteredReservations.map(reservation => reservation.flight);
                return flights;
            }

            function displayFlights(flights) {
                $('#flightsSection').show();
                const tableBody = $('#flightsBody');
                tableBody.empty();

                if (flights.length === 0) {
                    tableBody.append('<tr><td colspan="9">No recorded flights</td></tr>');
                } else {
                    flights.forEach(function (flight) {
                        const departureDate = new Date(flight.departureDateTime).toLocaleString();
                        const arrivalDate = new Date(flight.arrivalDateTime).toLocaleString();
                        const reviewButton = flight.status === 'Completed' ? `<button class="reviewBtn" data-flight='${JSON.stringify(flight)}'>Review</button>` : `<button class="review-btn" disabled>Review</button>`;
                        const row = `<tr>
                                    <td>${flight.id}</td>
                                    <td>${flight.airline.name}</td>
                                    <td>${flight.from} - ${flight.destination}</td>
                                    <td>${departureDate}</td>
                                    <td>${arrivalDate}</td>
                                    <td>${flight.availableSeats}</td>
                                    <td>${flight.bookedSeats}</td>
                                    <td>${flight.price}</td>
                                    <td>${flight.status}</td>
                                    <td>${reviewButton}</td>
                                </tr>`;
                        tableBody.append(row);
                    });
                }
            }

            function displayReservations(reservations) {
                $('#reservationsSection').show();
                const tableBody = $('#reservationsBody');
                tableBody.empty();

                if (reservations.length === 0) {
                    tableBody.append('<tr><td colspan="10">No reservations made</td></tr>');
                } else {
                    reservations.forEach(function (reservation) {
                        const flight = reservation.flight;
                        const departureDate = new Date(flight.departureDateTime).toLocaleString();
                        const arrivalDate = new Date(flight.arrivalDateTime).toLocaleString();
                        const now = new Date();
                        const isWithin24Hours = new Date(flight.departureDateTime) - now <= 24 * 60 * 60 * 1000;
                        const isDisabled = reservation.status === 'Cancelled' || reservation.status === 'Completed' || isWithin24Hours;
                        const row = `<tr>
                                    <td>${reservation.id}</td>
                                    <td>${reservation.user.username}</td>
                                    <td>${flight.id}</td>
                                    <td>${flight.from} - ${flight.destination}</td>
                                    <td>${departureDate}</td>
                                    <td>${arrivalDate}</td>
                                    <td>${reservation.numberOfPassengers}</td>
                                    <td>${reservation.totalPrice}</td>
                                    <td>${reservation.status}</td>
                                    <td class="center-checkbox"><input type="checkbox" class="cancel-checkbox" data-reservation='${JSON.stringify(reservation)}' ${isDisabled ? 'disabled' : ''}></td>
                                </tr>`;
                        tableBody.append(row);
                    });

                    $('#cancelReservationBtn').prop('disabled', true);
                    $('.cancel-checkbox').change(function () {
                        const anyChecked = $('.cancel-checkbox:checked').length > 0;
                        $('#cancelReservationBtn').prop('disabled', !anyChecked);
                    });
                }
            }

            function updateReservations(reservationsToUpdate) {
                $.ajax({
                    url: '/api/reservations/cancel',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reservationsToUpdate),
                    success: function (data) {
                        console.log('Successful response:', data);
                        loadProfile();
                    },
                    error: function (xhr) {
                        console.error('Failed to cancel reservations:', xhr.responseText);
                    }
                });
            }

            loadProfile();

            $('#logoutBtn').click(function (event) {
                event.preventDefault();
                $.ajax({
                    url: '/api/users/logout',
                    method: 'POST',
                    success: function () {
                        window.location.href = 'Index.html';
                    },
                    error: function (xhr) {
                        console.error('Failed to log out:', xhr.responseText);
                        window.location.href = 'Index.html';
                    }
                });
            });

            $('#editBtn').click(function () {
                $('#profileInfo').hide();
                $('#editProfileModal').show();
            });

            $('#editProfileForm').submit(function (event) {
                event.preventDefault();

                const updatedUser = {
                    Username: $('#editUsername').val(),
                    Password: $('#editPassword').val(),
                    FirstName: $('#editFirstName').val(),
                    LastName: $('#editLastName').val(),
                    Email: $('#editEmail').val(),
                    DateOfBirth: $('#editDateOfBirth').val(),
                    Gender: $('input[name="editGender"]:checked').val(),
                };

                $.ajax({
                    url: '/api/users/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedUser),
                    success: function (user) {
                        $('#editProfileModal').hide();
                        loadProfile();
                    },
                    error: function (xhr) {
                        console.error('Failed to update profile:', xhr.responseText);
                    }
                });
            });

            $('#cancelEditBtn').click(function () {
                $('#editProfileModal').hide();
                $('#profileInfo').show();
            });

            $(".datepicker").datepicker({
                dateFormat: 'dd/mm/yy',
                defaultDate: new Date(2000, 0, 1)
            });

            $('#editUsername').on('blur', function () {
                const username = $(this).val();
                const currentUsername = $(this).attr('data-current-username');
                if (username.length === 0 || username === currentUsername) {
                    $('#usernameError').text('');
                    return;
                }

                $.ajax({
                    url: `/api/users/${username}`,
                    method: 'GET',
                    success: function () {
                        if (username !== currentUsername) {
                            $('#usernameError').text('Username already exists.');
                        } else {
                            $('#usernameError').text('');
                        }
                    },
                    error: function (xhr) {
                        if (xhr.status === 404) {
                            $('#usernameError').text('');
                        } else {
                            $('#usernameError').text('Error checking username.');
                        }
                    }
                });
            });

            $('#filterBtn').click(function () {
                const status = $('#filterStatus').val();

                let filteredReservations = allUserReservations;
                if (status !== 'All') {
                    filteredReservations = allUserReservations.filter(reservation => reservation.status === status);
                }

                displayReservations(filteredReservations);
            });

            $('#filterFlightBtn').click(function () {
                const status = $('#filterFlightStatus').val();

                let filteredFlights = allUserFlights;
                if (status !== 'All') {
                    filteredFlights = allUserFlights.filter(flight => flight.status === status);
                }

                displayFlights(filteredFlights);
            });

            $('#cancelReservationBtn').click(function () {
                const reservationsToCancel = $('.cancel-checkbox:checked').map(function () {
                    return JSON.parse($(this).attr('data-reservation'));
                }).get();

                reservationsToCancel.forEach(function (reservation) {
                    reservation.status = 'Cancelled';
                });

                updateReservations(reservationsToCancel);
            });
            $(document).on('click', '.reviewBtn', function () {
                const flight = JSON.parse($(this).attr('data-flight'));
                $('#reviewFormContainer').show();
                $('#submitReviewBtn').data('flight', flight);
                $('html, body').animate({
                    scrollTop: $('#reviewFormContainer').offset().top
                }, 800);
            });

            $('#reviewImage').change(function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#imagePreview').attr('src', e.target.result).show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#imagePreview').hide();
                }
            });

            $('#submitReviewBtn').click(function (event) {
                event.preventDefault();

                const reviewTitle = $('#reviewTitle').val();
                const reviewContent = $('#reviewContent').val();
                const flight = $(this).data('flight');

                if (!reviewTitle) {
                    $('#reviewTitleError').text('Title can\'t be left empty.');
                    $('#reviewTitleError').show();
                } else {
                    $('#reviewTitleError').hide();
                }

                if (!reviewContent) {
                    $('#reviewContentError').text('Content can\'t be left empty.');
                    $('#reviewContentError').show();
                } else {
                    $('#reviewContentError').hide();
                }

                if (!reviewTitle || !reviewContent) {
                    return;
                }

                let reviewImage = 'None';
                const file = $('#reviewImage')[0].files[0];
                if (file) {
                    reviewImage = '/images/' + file.name;
                }

                const reviewData = {
                    user: currentUser,
                    airline: flight.airline,
                    title: reviewTitle,
                    content: reviewContent,
                    status: 'Approved',
                    image: reviewImage
                };

                $.ajax({
                    url: '/api/reviews/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reviewData),
                    success: function (response) {
                        console.log('Review submitted successfully:', response);
                        $('#reviewFormContainer').hide();
                        loadProfile();
                        $('#reviewFormContainer').hide();
                        $('#reviewTitle').val('');
                        $('#reviewContent').val('');
                        $('#reviewImage').val('');
                        $('#imagePreview').hide();
                        $('html, body').animate({
                            scrollTop: $('#flightsSection').offset().top
                        }, 800);
                    },
                    error: function (xhr) {
                        console.error('Failed to submit review:', xhr.responseText);
                    }
                });
            });
            $('#cancelReviewBtn').click(function () {
                $('#reviewFormContainer').hide();
                $('#reviewTitle').val('');
                $('#reviewContent').val('');
                $('#reviewTitleError').hide();
                $('#reviewContentError').hide();
                $('#reviewImage').val('');
                $('#imagePreview').hide();
                $('html, body').animate({
                    scrollTop: $('#flightsSection').offset().top
                }, 800);
            });
        });
    </script>
</head>
<body>
    <div class="menu">
        <a href="Index.html">Flights</a>
        <a href="Profile.html">Profile</a>
        <a href="#" id="logoutBtn">Log out</a>
    </div>
    <br />
    <h1 id="loadingMessage">Loading...</h1>
    <div id="profileInfo" style="display:none;">
        <h1 id="profileTitle"></h1>
        <ul>
            <li id="email"></li>
            <li id="dob"></li>
            <li id="gender"></li>
            <li id="type"></li>
        </ul>
        <button id="editBtn" style="margin-left:10px;">Edit Profile</button>
    </div>

    <div id="editProfileModal" style="display:none; margin-left:20px;">
        <form id="editProfileForm">
            <label for="editUsername">Username:</label>
            <input type="text" id="editUsername" name="editUsername" required><br>
            <span id="usernameError" class="error" style="display:block;"></span>
            <label for="editPassword">Password:</label>
            <input type="password" id="editPassword" name="editPassword" required><br>
            <label for="editFirstName">First Name:</label>
            <input type="text" id="editFirstName" name="editFirstName" required><br>
            <label for="editLastName">Last Name:</label>
            <input type="text" id="editLastName" name="editLastName" required><br>
            <label for="editEmail">Email:</label>
            <input type="email" id="editEmail" name="editEmail" required><br>
            <label for="editDateOfBirth">Date of Birth:</label>
            <input type="text" id="editDateOfBirth" name="editDateOfBirth" class="datepicker" required><br>
            <label>Gender:</label>
            <input type="radio" id="editMale" name="editGender" value="Male">
            <label for="editMale">Male</label>
            <input type="radio" id="editFemale" name="editGender" value="Female">
            <label for="editFemale">Female</label><br>
            <button type="submit">Save changes</button>
            <button type="button" id="cancelEditBtn">Cancel</button>
        </form>
    </div>
    <br />
    <br />
    <br />
    <div id="flightsSection" style="display: none; margin-left: 20px; margin-right:20px;">
        <h1>Your Flights</h1>
        <div style="margin-left:20px;">
            <label for="filterFlightStatus">Filter by Status:</label>
            <select id="filterFlightStatus">
                <option value="All">All</option>
                <option value="Active">Active</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Completed">Completed</option>
            </select>
            <button id="filterFlightBtn">Filter</button>
        </div>
        <br />
        <table>
            <thead>
                <tr>
                    <th>Flight ID</th>
                    <th>Airline</th>
                    <th>Route</th>
                    <th>Departure Time</th>
                    <th>Arrival Time</th>
                    <th>Available Seats</th>
                    <th>Booked Seats</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Review</th>
                </tr>
            </thead>
            <tbody id="flightsBody"></tbody>
        </table>
    </div>
    <br />
    <br />
    <br />
    <div id="reservationsSection" style="display: none; margin-left: 20px; margin-right:20px;">
        <h1>Your Reservations</h1>
        <div style="margin-left:20px;">
            <label for="filterStatus">Filter by Status:</label>
            <select id="filterStatus">
                <option value="All">All</option>
                <option value="Created">Created</option>
                <option value="Approved">Approved</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Completed">Completed</option>
            </select>
            <button id="filterBtn">Filter</button>
        </div>
        <br />
        <table id="reservationsTable">
            <thead>
                <tr>
                    <th>Reservation Id</th>
                    <th>Name</th>
                    <th>Flight Id</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Number of passengers</th>
                    <th>Total price (RSD)</th>
                    <th>Status</th>
                    <th>Cancel</th>
                </tr>
            </thead>
            <tbody id="reservationsBody">
            </tbody>
        </table>
        <br />
        <button id="cancelReservationBtn" style="margin-right:20px; float:right;">Cancel Reservation</button>
    </div>
    <br />
    <div id="reviewFormContainer" style="display: none; margin-left: 20px; margin-right: 20px;">
        <h1>Submit Review</h1>
        <form id="reviewForm">
            <label for="reviewTitle" style="margin-left:20px">Review Title:</label><br><br />
            <input type="text" id="reviewTitle" name="title" style="margin-left:20px" required><br />
            <span id="reviewTitleError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="reviewContent" style="margin-left:20px">Review Content:</label><br><br />
            <textarea id="reviewContent" name="content" rows="6" style="width: 400px; margin-left:20px;" required></textarea><br />
            <span id="reviewContentError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="reviewImage" style="margin-left:20px">Choose an Image:</label><br><br />
            <input type="file" id="reviewImage" accept="image/*" style="margin-left:20px"><br />
            <img id="imagePreview" style="margin-left:20px; display:none; max-width: 100px; max-height: 100px;" /><br />
            <button type="submit" id="submitReviewBtn" style="margin-left:20px">Submit Review</button>
            <button type="button" id="cancelReviewBtn">Cancel</button>
        </form>
    </div>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
</body>
</html>