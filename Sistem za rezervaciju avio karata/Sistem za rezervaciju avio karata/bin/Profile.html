<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Profile</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="MainStyle.css">
    <script>
        $(document).ready(function () {
            let allUserReservations = [];
            let allUserFlights = [];
            let currentUser = null;
            let allUsers = [];
            let allUsersFiltered = [];
            let allReviews = [];
            let allAirlines = [];
            let allReservations = [];

            function loadProfile() {
                $.ajax({
                    url: '/api/users/currentuser',
                    method: 'GET',
                    success: function (user) {
                        currentUser = user;
                        document.title = `${user.username}'s Profile`;
                        $('#profileTitle').text(`${user.username} (${user.firstName} ${user.lastName})`);
                        $('#email').text(`Email: ${user.email}`);
                        $('#dob').text(`Date of Birth: ${user.dateOfBirth}`);
                        $('#gender').text(`Gender: ${user.gender}`);
                        $('#type').text(`User type: ${user.userType}`);
                        $('#profileInfo').show();
                        $('#loadingMessage').hide();

                        $('#editUsername').val(user.username);
                        $('#editUsername').attr('data-current-username', user.username);
                        $('#editPassword').val(user.password);
                        $('#editFirstName').val(user.firstName);
                        $('#editLastName').val(user.lastName);
                        $('#editEmail').val(user.email);
                        $('#editDateOfBirth').val(user.dateOfBirth);
                        $('input[name="editGender"][value="' + user.gender + '"]').prop('checked', true);

                        if (user.userType === 'Admin') {
                            loadAllUsersTable();
                            loadCreatedReviewsTable();
                            loadAllAirlines();
                            loadAllReservations();
                        } else if (user.userType === 'Traveler') {
                            allUserReservations = user.reservations;
                            allUserFlights = extractFlightsFromReservations(allUserReservations);
                            displayFlights(allUserFlights);
                            displayReservations(allUserReservations);
                        }
                    },
                    error: function (xhr) {
                        console.error(`Failed to load profile: ${xhr.responseText}`);
                        window.location.href = 'Login.html';
                    }
                });
            }

            function extractFlightsFromReservations(reservations) {
                const filteredReservations = reservations.filter(reservation =>
                    reservation.status === 'Created' ||
                    reservation.status === 'Approved' ||
                    reservation.status === 'Completed'
                );
                const flights = filteredReservations.map(reservation => reservation.flight);
                return flights;
            }

            function displayFlights(flights) {
                $('#flightsSection').show();
                const tableBody = $('#flightsBody');
                tableBody.empty();

                if (flights.length === 0) {
                    tableBody.append('<tr><td colspan="9">No recorded flights</td></tr>');
                } else {
                    flights.forEach(function (flight) {
                        const departureDate = new Date(flight.departureDateTime).toLocaleString();
                        const arrivalDate = new Date(flight.arrivalDateTime).toLocaleString();
                        const reviewButton = flight.status === 'Completed' ? `<button class="reviewBtn" data-flight='${JSON.stringify(flight)}'>Review</button>` : `<button class="review-btn" disabled>Review</button>`;
                        const row = `<tr>
                                    <td>${flight.id}</td>
                                    <td>${flight.airline.name}</td>
                                    <td>${flight.from} - ${flight.destination}</td>
                                    <td>${departureDate}</td>
                                    <td>${arrivalDate}</td>
                                    <td>${flight.availableSeats}</td>
                                    <td>${flight.bookedSeats}</td>
                                    <td>${flight.price}</td>
                                    <td>${flight.status}</td>
                                    <td>${reviewButton}</td>
                                </tr>`;
                        tableBody.append(row);
                    });
                }
            }

            function displayReservations(reservations) {
                $('#reservationsSection').show();
                const tableBody = $('#reservationsBody');
                tableBody.empty();

                if (reservations.length === 0) {
                    tableBody.append('<tr><td colspan="10">No reservations made</td></tr>');
                } else {
                    reservations.forEach(function (reservation) {
                        const flight = reservation.flight;
                        const departureDate = new Date(flight.departureDateTime).toLocaleString();
                        const arrivalDate = new Date(flight.arrivalDateTime).toLocaleString();
                        const now = new Date();
                        const isWithin24Hours = new Date(flight.departureDateTime) - now <= 24 * 60 * 60 * 1000;
                        const isDisabled = reservation.status === 'Cancelled' || reservation.status === 'Completed' || isWithin24Hours;
                        const row = `<tr>
                                    <td>${reservation.id}</td>
                                    <td>${reservation.user.username}</td>
                                    <td>${flight.id}</td>
                                    <td>${flight.from} - ${flight.destination}</td>
                                    <td>${departureDate}</td>
                                    <td>${arrivalDate}</td>
                                    <td>${reservation.numberOfPassengers}</td>
                                    <td>${reservation.totalPrice}</td>
                                    <td>${reservation.status}</td>
                                    <td class="center-checkbox"><input type="checkbox" class="cancel-checkbox" data-reservation='${JSON.stringify(reservation)}' ${isDisabled ? 'disabled' : ''}></td>
                                </tr>`;
                        tableBody.append(row);
                    });

                    $('#cancelReservationBtn').prop('disabled', true);
                    $('.cancel-checkbox').change(function () {
                        const anyChecked = $('.cancel-checkbox:checked').length > 0;
                        $('#cancelReservationBtn').prop('disabled', !anyChecked);
                    });
                }
            }

            function updateReservations(reservationsToUpdate) {
                $.ajax({
                    url: '/api/reservations/cancel',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reservationsToUpdate),
                    success: function (data) {
                        console.log('Successful response:', data);
                        loadProfile();
                    },
                    error: function (xhr) {
                        console.error('Failed to cancel reservations:', xhr.responseText);
                    }
                });
            }

            loadProfile();

            $('#logoutBtn').click(function (event) {
                event.preventDefault();
                $.ajax({
                    url: '/api/users/logout',
                    method: 'POST',
                    success: function () {
                        window.location.href = 'Index.html';
                    },
                    error: function (xhr) {
                        console.error('Failed to log out:', xhr.responseText);
                        window.location.href = 'Index.html';
                    }
                });
            });

            $('#editBtn').click(function () {
                $('#profileInfo').hide();
                $('#editProfileModal').show();
            });

            $('#editProfileForm').submit(function (event) {
                event.preventDefault();

                const updatedUser = {
                    Username: $('#editUsername').val(),
                    Password: $('#editPassword').val(),
                    FirstName: $('#editFirstName').val(),
                    LastName: $('#editLastName').val(),
                    Email: $('#editEmail').val(),
                    DateOfBirth: $('#editDateOfBirth').val(),
                    Gender: $('input[name="editGender"]:checked').val(),
                };

                $.ajax({
                    url: '/api/users/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedUser),
                    success: function (user) {
                        $('#editProfileModal').hide();
                        loadProfile();
                    },
                    error: function (xhr) {
                        console.error('Failed to update profile:', xhr.responseText);
                    }
                });
            });

            $('#cancelEditBtn').click(function () {
                $('#editProfileModal').hide();
                $('#profileInfo').show();
            });

            $(".datepicker").datepicker({
                dateFormat: 'dd/mm/yy',
                defaultDate: new Date(2000, 0, 1)
            });

            $('#editUsername').on('blur', function () {
                const username = $(this).val();
                const currentUsername = $(this).attr('data-current-username');
                if (username.length === 0 || username === currentUsername) {
                    $('#usernameError').text('');
                    return;
                }

                $.ajax({
                    url: `/api/users/${username}`,
                    method: 'GET',
                    success: function () {
                        if (username !== currentUsername) {
                            $('#usernameError').text('Username already exists.');
                        } else {
                            $('#usernameError').text('');
                        }
                    },
                    error: function (xhr) {
                        if (xhr.status === 404) {
                            $('#usernameError').text('');
                        } else {
                            $('#usernameError').text('Error checking username.');
                        }
                    }
                });
            });

            $('#filterBtn').click(function () {
                const status = $('#filterStatus').val();

                let filteredReservations = allUserReservations;
                if (status !== 'All') {
                    filteredReservations = allUserReservations.filter(reservation => reservation.status === status);
                }

                displayReservations(filteredReservations);
            });

            $('#filterFlightBtn').click(function () {
                const status = $('#filterFlightStatus').val();

                let filteredFlights = allUserFlights;
                if (status !== 'All') {
                    filteredFlights = allUserFlights.filter(flight => flight.status === status);
                }

                displayFlights(filteredFlights);
            });

            $('#cancelReservationBtn').click(function () {
                const reservationsToCancel = $('.cancel-checkbox:checked').map(function () {
                    return JSON.parse($(this).attr('data-reservation'));
                }).get();

                reservationsToCancel.forEach(function (reservation) {
                    reservation.status = 'Cancelled';
                });

                updateReservations(reservationsToCancel);
            });
            $(document).on('click', '.reviewBtn', function () {
                const flight = JSON.parse($(this).attr('data-flight'));
                $('#reviewFormContainer').show();
                $('#submitReviewBtn').data('flight', flight);
                $('html, body').animate({
                    scrollTop: $('#reviewFormContainer').offset().top
                }, 800);
            });

            $('#reviewImage').change(function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#imagePreview').attr('src', e.target.result).show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#imagePreview').hide();
                }
            });

            $('#submitReviewBtn').click(function (event) {
                event.preventDefault();

                const reviewTitle = $('#reviewTitle').val();
                const reviewContent = $('#reviewContent').val();
                const flight = $(this).data('flight');

                if (!reviewTitle) {
                    $('#reviewTitleError').text('Title can\'t be left empty.');
                    $('#reviewTitleError').show();
                } else {
                    $('#reviewTitleError').hide();
                }

                if (!reviewContent) {
                    $('#reviewContentError').text('Content can\'t be left empty.');
                    $('#reviewContentError').show();
                } else {
                    $('#reviewContentError').hide();
                }

                if (!reviewTitle || !reviewContent) {
                    return;
                }

                let reviewImage = 'None';
                const file = $('#reviewImage')[0].files[0];
                if (file) {
                    reviewImage = '/images/' + file.name;
                }

                const reviewData = {
                    user: currentUser,
                    airline: flight.airline,
                    title: reviewTitle,
                    content: reviewContent,
                    status: 'Created',
                    image: reviewImage
                };

                $.ajax({
                    url: '/api/reviews/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(reviewData),
                    success: function (response) {
                        console.log('Review submitted successfully:', response);
                        $('#reviewFormContainer').hide();
                        loadProfile();
                        $('#reviewFormContainer').hide();
                        $('#reviewTitle').val('');
                        $('#reviewContent').val('');
                        $('#reviewImage').val('');
                        $('#imagePreview').hide();
                        $('html, body').animate({
                            scrollTop: $('#flightsSection').offset().top
                        }, 800);
                    },
                    error: function (xhr) {
                        console.error('Failed to submit review:', xhr.responseText);
                    }
                });
            });
            $('#cancelReviewBtn').click(function () {
                $('#reviewFormContainer').hide();
                $('#reviewTitle').val('');
                $('#reviewContent').val('');
                $('#reviewTitleError').hide();
                $('#reviewContentError').hide();
                $('#reviewImage').val('');
                $('#imagePreview').hide();
                $('html, body').animate({
                    scrollTop: $('#flightsSection').offset().top
                }, 800);
            });
            function loadAllUsersTable() {
                $.ajax({
                    url: '/api/users',
                    method: 'GET',
                    success: function (users) {
                        allUsers = users;
                        allUsersFiltered = users;
                        displayUsers(users);
                        $('#adminUsersTable').show();
                    },
                    error: function (xhr) {
                        console.error('Failed to load users:', xhr.responseText);
                    }
                });
            }

            function displayUsers(users) {
                const tableBody = $('#adminUsersTableBody');
                tableBody.empty();

                if (users.length === 0) {
                    tableBody.append('<tr><td colspan="7">No users found</td></tr>');
                } else {
                    users.forEach(function (user) {
                        const row = `<tr>
                    <td>${user.username}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastName}</td>
                    <td>${user.email}</td>
                    <td>${user.dateOfBirth}</td>
                    <td>${user.gender}</td>
                    <td>${user.userType}</td>
                </tr>`;
                        tableBody.append(row);
                    });
                }
            }
            function sortUsers(criteria) {
                switch (criteria) {
                    case 'firstName_ASC':
                        allUsersFiltered.sort((a, b) => a.firstName.localeCompare(b.firstName));
                        break;
                    case 'firstName_DESC':
                        allUsersFiltered.sort((a, b) => b.firstName.localeCompare(a.firstName));
                        break;
                    case 'dateOfBirth_ASC':
                        allUsersFiltered.sort(function (a, b) {
                            aArr = a.dateOfBirth.split('/');
                            bArr = b.dateOfBirth.split('/');
                            return new Date(aArr[2], Number(aArr[1]) - 1, aArr[0]).getTime() - new Date(bArr[2], Number(bArr[1]) - 1, bArr[0]).getTime()
                        });
                        break;
                    case 'dateOfBirth_DESC':
                        allUsersFiltered.sort(function (a, b) {
                            aArr = a.dateOfBirth.split('/');
                            bArr = b.dateOfBirth.split('/');
                            return new Date(bArr[2], Number(bArr[1]) - 1, bArr[0]).getTime() - new Date(aArr[2], Number(aArr[1]) - 1, aArr[0]).getTime()
                        });
                        break;
                }

                displayUsers(allUsersFiltered);
            }
            $('#sortUsersBy').change(function () {
                const selectedCriteria = $('#sortUsersBy').val();
                sortUsers(selectedCriteria);
            });
            $('#searchForm').submit(function (event) {
                event.preventDefault();

                let firstName = $('#firstName').val().trim().toLowerCase();
                let lastName = $('#lastName').val().trim().toLowerCase();
                let fromDateStr = $('#bornFrom').val();
                let fromDateArr = fromDateStr.split('/');
                let fromDate = new Date(fromDateArr[2], Number(fromDateArr[1]) - 1, fromDateArr[0]);
                let toDateStr = $('#bornTo').val();
                let toDateArr = toDateStr.split('/');
                let toDate = new Date(toDateArr[2], Number(toDateArr[1]) - 1, toDateArr[0]);
                let filteredUsers = allUsers.filter(function (user) {
                    let userArr = user.dateOfBirth.split('/');
                    let userDate = new Date(userArr[2], Number(userArr[1]) - 1, userArr[0]);
                    let matchFirstName = firstName === '' || user.firstName.toLowerCase().includes(firstName);
                    let matchLastName = lastName === '' || user.lastName.toLowerCase().includes(lastName);
                    let matchBirthDate = true;
                    if (fromDateStr !== "" && toDateStr !== "") {
                        matchBirthDate = userDate >= fromDate && userDate <= toDate;
                    }
                    return matchFirstName && matchLastName && matchBirthDate;
                });
                allUsersFiltered = filteredUsers;
                displayUsers(filteredUsers);
            });

            $(function () {
                $(".datepicker").datepicker({ dateFormat: 'dd/mm/yy' });
            });

            function loadCreatedReviewsTable() {
                $.ajax({
                    url: '/api/reviews',
                    method: 'GET',
                    success: function (reviews) {
                        allReviews = reviews;
                        displayReviews(reviews);
                        $('#createdReviews').show();
                    },
                    error: function (xhr) {
                        console.error('Failed to load reviews:', xhr.responseText);
                    }
                });
            }

            function displayReviews(reviews){
                const tableBody = $('#createdReviewsTableBody');
                tableBody.empty();

                let counter = 0;

                if (reviews.length === 0) {
                    tableBody.append('<tr><td colspan="9">No created reviews found</td></tr>');
                } else {
                    reviews.forEach(function (review) {
                        if (review.status === 'Created') {
                            counter += 1;
                            let imageHtml = '';
                            if (review.image !== 'None') {
                                imageHtml = '<img src="' + review.image + '" alt="Review Image">';
                            }
                            let stringifiedReview = JSON.stringify(review)
                                .replace("'", '&#39;')
                                .replace("&", '&amp;')
                                .replace("<", '&lt;')
                                .replace(">", '&gt;');
                            const row = `<tr>
                    <td>${review.id}</td>
                    <td>${review.user.username}</td>
                    <td>${review.airline.name}</td>
                    <td>${review.title}</td>
                    <td>${review.content}</td>
                    <td>${imageHtml}</td>
                    <td>${review.status}</td>
                    <td><button class="approveBtn" data-review='${stringifiedReview}'>Approve</button></td>
                    <td><button class="rejectBtn" data-review='${stringifiedReview}'>Reject</button></td>
                </tr>`;
                            tableBody.append(row);
                        }  
                    });
                    if (counter === 0) {
                        tableBody.append('<tr><td colspan="9">No created reviews found</td></tr>');
                    }
                }
            }

            $(document).on('click', '.approveBtn', function () {
                const review = JSON.parse($(this).attr('data-review'));
                review.status = 'Approved';

                let stringifiedReview = JSON.stringify(review)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: 'api/reviews/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedReview,
                    success: function () {
                        loadCreatedReviewsTable();
                    },
                    error: function (xhr) {
                        console.error('Failed to approve review:', xhr.responseText);
                    }
                });
            });

            $(document).on('click', '.rejectBtn', function () {
                const review = JSON.parse($(this).attr('data-review'));
                review.status = 'Rejected';

                let stringifiedReview = JSON.stringify(review)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: 'api/reviews/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedReview,
                    success: function () {
                        loadCreatedReviewsTable();
                    },
                    error: function (xhr) {
                        console.error('Failed to approve review:', xhr.responseText);
                    }
                });
            });

            function loadAllAirlines() {
                $.ajax({
                    url: '/api/airlines',
                    method: 'GET',
                    success: function (airlines) {
                        allAirlines = airlines;
                        displayAirlines(airlines);
                        $('#adminAirlinesSection').show();
                    },
                    error: function (xhr) {
                        console.error('Failed to load airlines:', xhr.responseText);
                    }
                });
            }

            function displayAirlines(airlines) {
                const tableBody = $('#allAirlinesTableBody');
                tableBody.empty();

                let counter = 0;

                if (airlines.length === 0) {
                    tableBody.append('<tr><td colspan="9">No airlines found</td></tr>');
                } else {
                    airlines.forEach(function (airline) {
                        if (!airline.isDeleted) {
                            counter += 1;
                            let stringifiedAirline = JSON.stringify(airline)
                                .replace("'", '&#39;')
                                .replace("&", '&amp;')
                                .replace("<", '&lt;')
                                .replace(">", '&gt;');
                            let hasActiveFlight = false;
                            airline.flights.forEach(function (flight) {
                                if (flight.status === 'Active') {
                                    hasActiveFlight = true;
                                }
                            });
                            
                            let removeBtn = `<td><button class="removeAirlineBtn" data-airline='${stringifiedAirline}'>Remove</button></td>`
                            if (hasActiveFlight) {
                                removeBtn = `<td><button class="removeAirlineBtn" data-airline='${stringifiedAirline}' disabled>Remove</button></td>`
                            }
                            const row = `<tr>
                    <td>${airline.id}</td>
                    <td>${airline.name}</td>
                    <td>${airline.address}</td>
                    <td>${airline.contactInfo}</td>
                    ${removeBtn}
                    <td><button class="editAirlineBtn" data-airline='${stringifiedAirline}'>Edit</button></td>
                </tr>`;
                            tableBody.append(row);
                        }
                    });
                    if (counter === 0) {
                        tableBody.append('<tr><td colspan="6">No  airlines found</td></tr>');
                    }
                }
            }
            $(document).on('click', '.removeAirlineBtn', function () {
                const airline = JSON.parse($(this).attr('data-airline'));

                let stringifiedAirline = JSON.stringify(airline)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: 'api/airlines/remove',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedAirline,
                    success: function () {
                        loadAllAirlines();
                    },
                    error: function (xhr) {
                        console.error('Failed to remove airline:', xhr.responseText);
                    }
                });
            });

            $('#addAirlineBtn').click(function (event) {
                event.preventDefault();

                const airlineName = $('#airlineName').val();
                const airlineAddress = $('#airlineAddress').val();
                const airlineContact = $('#airlineContact').val();

                let shouldReturn = false;

                if (!airlineName) {
                    $('#airlineNameError').text('Name can\'t be left empty.');
                    $('#airlineNameError').show();
                    shouldReturn = true;
                } else {
                    $('#airlineNameError').hide();
                }

                if (!airlineAddress) {
                    $('#airlineAddressError').text('Address can\'t be left empty.');
                    $('#airlineAddressError').show();
                    shouldReturn = true;
                } else {
                    $('#airlineAddressError').hide();
                }

                if (!airlineContact) {
                    $('#airlineContactError').text('Contact info can\'t be left empty.');
                    $('#airlineContactError').show();
                    shouldReturn = true;
                } else {
                    $('#airlineContactError').hide();
                }

                if (shouldReturn) {
                    return;
                }

                const airlineData = {
                    name: airlineName,
                    address: airlineAddress,
                    contactInfo: airlineContact
                };

                let stringifiedAirline = JSON.stringify(airlineData)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: '/api/airlines/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedAirline,
                    success: function (response) {
                        console.log('Review submitted successfully:', response);
                        $('#airlineName').val('');
                        $('#airlineAddress').val('');
                        $('#airlineContact').val('');
                        loadAllAirlines();
                    },
                    error: function (xhr) {
                        console.error('Failed to submit review:', xhr.responseText);
                    }
                });
            });

            $('#searchFormAirlines').submit(function (event) {
                event.preventDefault();

                let airlineName = $('#searchAirlineName').val().trim().toLowerCase();
                let airlineAddress = $('#searchAirlineAddress').val().trim().toLowerCase();
                let airlineContact = $('#searchAirlineContact').val().trim().toLowerCase();
                let filteredAirlines = allAirlines.filter(function (airline) {
                    let matchAirlineName = airlineName === '' || airline.name.toLowerCase().includes(airlineName);
                    let matchAirlineAddress = airlineAddress === '' || airline.address.toLowerCase().includes(airlineAddress);
                    let matchAirlineContact = airlineContact === '' || airline.contactInfo.toLowerCase().includes(airlineContact);
                    return matchAirlineName && matchAirlineAddress && matchAirlineContact;
                });

                displayAirlines(filteredAirlines);
            });
            $(document).on('click', '.editAirlineBtn', function () {
                const airline = JSON.parse($(this).attr('data-airline'));
                $('#editAirlineId').val(airline.id);
                $('#editAirlineName').val(airline.name);
                $('#editAirlineAddress').val(airline.address);
                $('#editAirlineContact').val(airline.contactInfo);
                $('#editAirlineModal').show();
            });

            $('#editAirlineForm').submit(function (event) {
                event.preventDefault();

                const airlineData = {
                    id: $('#editAirlineId').val(),
                    name: $('#editAirlineName').val(),
                    address: $('#editAirlineAddress').val(),
                    contactInfo: $('#editAirlineContact').val()
                };

                let stringifiedAirline = JSON.stringify(airlineData)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: '/api/airlines/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedAirline,
                    success: function (response) {
                        console.log('Airline updated successfully:', response);
                        $('#editAirlineModal').hide();
                        loadAllAirlines();
                    },
                    error: function (xhr) {
                        console.error('Failed to update airline:', xhr.responseText);
                    }
                });
            });

            $('#cancelEditAirline').click(function () {
                $('#editAirlineName').val('');
                $('#editAirlineAddress').val('');
                $('#editAirlineContact').val('');
                $('#editAirlineModal').hide();
            });

            function loadAllReservations() {
                $.ajax({
                    url: '/api/reservations/get',
                    method: 'GET',
                    success: function (reservations) {
                        allReservations = reservations;
                        displayAllReservations(reservations);
                        $('#allReservations').show();
                    },
                    error: function (xhr) {
                        console.error('Failed to load reservations:', xhr.responseText);
                    }
                });
            }

            function displayAllReservations(reservations) {
                const tableBody = $('#allReservationsTableBody');
                tableBody.empty();

                if (reservations.length === 0) {
                    tableBody.append('<tr><td colspan="9">No users found</td></tr>');
                } else {
                    reservations.forEach(function (reservation) {
                        let stringifiedReservation = JSON.stringify(reservation)
                            .replace("'", '&#39;')
                            .replace("&", '&amp;')
                            .replace("<", '&lt;')
                            .replace(">", '&gt;');
                        let route = `${reservation.flight.from} - ${reservation.flight.destination}`;
                        let disabledPortion = 'disabled';
                        if (reservation.status === 'Created') {
                            disabledPortion = '';
                        }
                        let approveReservationBtn = `<td><button class="approveReservationBtn" data-reservation='${stringifiedReservation}' ${disabledPortion}>Approve</button></td>`;
                        let cancelReservationBtn = `<td><button class="cancelReservationBtn" data-reservation='${stringifiedReservation}' ${disabledPortion}>Cancel</button></td>`;
                        const row = `<tr>
                    <td>${reservation.id}</td>
                    <td>${reservation.user.username}</td>
                    <td>${reservation.flight.id}</td>
                    <td>${route}</td>
                    <td>${reservation.numberOfPassengers}</td>
                    <td>${reservation.totalPrice}</td>
                    <td>${reservation.status}</td>
                    ${approveReservationBtn}
                    ${cancelReservationBtn}
                </tr>`;
                        tableBody.append(row);
                    });
                }
            }
            $(document).on('click', '.approveReservationBtn', function () {
                const reservation = JSON.parse($(this).attr('data-reservation'));
                reservation.status = 'Approved';

                let stringifiedReservation = JSON.stringify(reservation)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: 'api/reservations/change',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedReservation,
                    success: function () {
                        loadAllReservations();
                    },
                    error: function (xhr) {
                        console.error('Failed to approve reservation:', xhr.responseText);
                    }
                });
            });
            $(document).on('click', '.cancelReservationBtn', function () {
                const reservation = JSON.parse($(this).attr('data-reservation'));
                reservation.status = 'Cancelled';

                let stringifiedReservation = JSON.stringify(reservation)
                    .replace("'", '&#39;')
                    .replace("&", '&amp;')
                    .replace("<", '&lt;')
                    .replace(">", '&gt;');

                $.ajax({
                    url: 'api/reservations/change',
                    method: 'POST',
                    contentType: 'application/json',
                    data: stringifiedReservation,
                    success: function () {
                        loadAllReservations();
                    },
                    error: function (xhr) {
                        console.error('Failed to approve reservation:', xhr.responseText);
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div class="menu">
        <a href="Index.html">Flights</a>
        <a href="Profile.html">Profile</a>
        <a href="#" id="logoutBtn">Log out</a>
    </div>
    <br />
    <h1 id="loadingMessage">Loading...</h1>
    <div id="profileInfo" style="display:none;">
        <h1 id="profileTitle"></h1>
        <ul>
            <li id="email"></li>
            <li id="dob"></li>
            <li id="gender"></li>
            <li id="type"></li>
        </ul>
        <button id="editBtn" style="margin-left:10px;">Edit Profile</button>
    </div>

    <div id="editProfileModal" style="display:none; margin-left:20px;">
        <form id="editProfileForm">
            <label for="editUsername">Username:</label>
            <input type="text" id="editUsername" name="editUsername" required><br>
            <span id="usernameError" class="error" style="display:block;"></span>
            <label for="editPassword">Password:</label>
            <input type="password" id="editPassword" name="editPassword" required><br>
            <label for="editFirstName">First Name:</label>
            <input type="text" id="editFirstName" name="editFirstName" required><br>
            <label for="editLastName">Last Name:</label>
            <input type="text" id="editLastName" name="editLastName" required><br>
            <label for="editEmail">Email:</label>
            <input type="email" id="editEmail" name="editEmail" required><br>
            <label for="editDateOfBirth">Date of Birth:</label>
            <input type="text" id="editDateOfBirth" name="editDateOfBirth" class="datepicker" required><br>
            <label>Gender:</label>
            <input type="radio" id="editMale" name="editGender" value="Male">
            <label for="editMale">Male</label>
            <input type="radio" id="editFemale" name="editGender" value="Female">
            <label for="editFemale">Female</label><br>
            <button type="submit">Save changes</button>
            <button type="button" id="cancelEditBtn">Cancel</button>
        </form>
    </div>
    <div id="flightsSection" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <br />
        <br />
        <h1>Your Flights</h1>
        <div style="margin-left:20px;">
            <label for="filterFlightStatus">Filter by Status:</label>
            <select id="filterFlightStatus">
                <option value="All">All</option>
                <option value="Active">Active</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Completed">Completed</option>
            </select>
            <button id="filterFlightBtn">Filter</button>
        </div>
        <br />
        <table>
            <thead>
                <tr>
                    <th>Flight ID</th>
                    <th>Airline</th>
                    <th>Route</th>
                    <th>Departure Time</th>
                    <th>Arrival Time</th>
                    <th>Available Seats</th>
                    <th>Booked Seats</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Review</th>
                </tr>
            </thead>
            <tbody id="flightsBody"></tbody>
        </table>
    </div>
    <div id="reservationsSection" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <br />
        <br />
        <h1>Your Reservations</h1>
        <div style="margin-left:20px;">
            <label for="filterStatus">Filter by Status:</label>
            <select id="filterStatus">
                <option value="All">All</option>
                <option value="Created">Created</option>
                <option value="Approved">Approved</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Completed">Completed</option>
            </select>
            <button id="filterBtn">Filter</button>
        </div>
        <br />
        <table id="reservationsTable">
            <thead>
                <tr>
                    <th>Reservation Id</th>
                    <th>Name</th>
                    <th>Flight Id</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Number of passengers</th>
                    <th>Total price (RSD)</th>
                    <th>Status</th>
                    <th>Cancel</th>
                </tr>
            </thead>
            <tbody id="reservationsBody">
            </tbody>
        </table>
        <br />
        <button id="cancelReservationBtn" style="margin-right:20px; float:right;">Cancel Reservation</button>
    </div>
    <div id="reviewFormContainer" style="display: none; margin-left: 20px; margin-right: 20px;">
        <br />
        <h1>Submit Review</h1>
        <form id="reviewForm">
            <label for="reviewTitle" style="margin-left:20px">Review Title:</label><br><br />
            <input type="text" id="reviewTitle" name="title" style="margin-left:20px" required><br />
            <span id="reviewTitleError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="reviewContent" style="margin-left:20px">Review Content:</label><br><br />
            <textarea id="reviewContent" name="content" rows="6" style="width: 400px; margin-left:20px;" required></textarea><br />
            <span id="reviewContentError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="reviewImage" style="margin-left:20px">Choose an Image:</label><br><br />
            <input type="file" id="reviewImage" accept="image/*" style="margin-left:20px"><br />
            <img id="imagePreview" style="margin-left:20px; display:none; max-width: 100px; max-height: 100px;" /><br />
            <button type="submit" id="submitReviewBtn" style="margin-left:20px">Submit Review</button>
            <button type="button" id="cancelReviewBtn">Cancel</button>
        </form>
    </div>
    <div id="adminUsersTable" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <br />
        <br />
        <h1>Registered Users</h1>
        <br />
        <div>
            <form id="searchForm" class="search">
                <label for="firstName">First name:</label>
                <input type="text" id="firstName" class="input-field">
                <label for="lastName">Last name:</label>
                <input type="text" id="lastName" class="input-field">
                <label for="bornFrom">Born from:</label>
                <input type="text" id="bornFrom" class="datepicker">
                <label for="bornTo">Born to:</label>
                <input type="text" id="bornTo" class="datepicker">
                <input type="submit" value="Search">
            </form>
            <div style="float:right;">
                <label for="sortUsersBy">Sort by:</label>
                <select id="sortUsersBy" class="sort">
                    <option value="firstName_ASC">First Name (Ascending)</option>
                    <option value="firstName_DESC">First Name (Descending)</option>
                    <option value="dateOfBirth_ASC">Date of Birth (Ascending)</option>
                    <option value="dateOfBirth_DESC">Date of Birth (Descending)</option>
                </select>
            </div>
        </div>
        <br />
        <table id="adminUsersTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Date of Birth</th>
                    <th>Gender</th>
                    <th>User Type</th>
                </tr>
            </thead>
            <tbody id="adminUsersTableBody">
            </tbody>
        </table>
    </div>
    <div id="adminAirlinesSection" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <h1>Add airline</h1>
        <br />
        <form id="addAirlineForm">
            <label for="airlineName" style="margin-left:20px">Airline Name:</label><br />
            <input type="text" id="airlineName" name="name" style="margin-left:20px" required><br />
            <span id="airlineNameError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="airlineAddress" style="margin-left:20px">Airline Address:</label><br />
            <input type="text" id="airlineAddress" name="address" style="margin-left:20px" required><br />
            <span id="airlineAddressError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <label for="airlineContact" style="margin-left:20px">Airline Contact info:</label><br />
            <input type="text" id="airlineContact" name="contact" style="margin-left:20px" required><br />
            <span id="airlineContactError" class="error" style="display: block; color: red; margin-left:20px;"></span><br />
            <button type="submit" id="addAirlineBtn" style="margin-left:20px">Add airline</button>
        </form>
        <br />
        <div id="editAirlineModal" style="display:none;">
            <h1>Edit Airline</h1>
            <br />
            <form id="editAirlineForm">
                <input type="hidden" id="editAirlineId">
                <label for="editAirlineName" style="margin-left:20px">Name:</label><br>
                <input type="text" id="editAirlineName" style="margin-left:20px" required><br>
                <label for="editAirlineAddress" style="margin-left:20px">Address:</label><br>
                <input type="text" id="editAirlineAddress" style="margin-left:20px" required><br>
                <label for="editAirlineContact" style="margin-left:20px">Contact Info:</label><br>
                <input type="text" id="editAirlineContact" style="margin-left:20px" required><br>
                <button type="submit" style="margin-left:20px">Save</button>
                <button type="button" id="cancelEditAirline" style="margin-left:20px">Cancel</button>
            </form>
        </div>
        <br />
        <h1>All airlines</h1>
        <br />
        <div>
            <form id="searchFormAirlines" class="search">
                <label for="searchAirlineName">Airline name:</label>
                <input type="text" id="searchAirlineName" class="input-field">
                <label for="searchAirlineAddress">Airline address:</label>
                <input type="text" id="searchAirlineAddress" class="input-field">
                <label for="searchAirlineContact">Airline contact:</label>
                <input type="text" id="searchAirlineContact" class="input-field">
                <input type="submit" value="Search">
            </form>
        </div>
        <br />
        <table id="allAirlinesTable">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Contact</th>
                    <th>Delete</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody id="allAirlinesTableBody">
            </tbody>
        </table>
    </div>
    <div id="allReservations" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <h1>All reservations</h1>
        <br />
        <table id="allReservationsTable">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>User</th>
                    <th>Flight</th>
                    <th>Route</th>
                    <th>Number of passengers</th>
                    <th>Total price</th>
                    <th>Status</th>
                    <th>Approve</th>
                    <th>Cancel</th>
                </tr>
            </thead>
            <tbody id="allReservationsTableBody">
            </tbody>
        </table>
    </div>
    <div id="createdReviews" style="display: none; margin-left: 20px; margin-right:20px;">
        <br />
        <h1>Created reviews</h1>
        <br />
        <table id="createdReviewsTable">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>User</th>
                    <th>Airline</th>
                    <th>Title</th>
                    <th>Content</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Approve</th>
                    <th>Reject</th>
                </tr>
            </thead>
            <tbody id="createdReviewsTableBody">
            </tbody>
        </table>
    </div>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
</body>
</html>