<!DOCTYPE html>
<html>
<head>
    <title>Flights</title>
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="MainStyle.css">
    <script type="text/javascript">
        $(document).ready(function () {
            let flightsData = [];

            loadFlights();

            loadAirlines();

            function loadAirlines() {
                $.ajax({
                    url: "/api/airlines",
                    method: "GET",
                    success: function (data) {
                        populateAirlinesDropdown(data);
                    },
                    error: function () {
                        console.error("Error fetching airlines data.");
                    }
                });
            }

            function populateAirlinesDropdown(airlines) {
                let select = $('#airlineName');
                select.empty();
                select.append($('<option>', {
                    value: '',
                    text: '-'
                }));
                airlines.forEach(function (airline) {
                    select.append($('<option>', {
                        value: airline.name,
                        text: airline.name
                    }));
                });
            }

            function loadFlights() {
                $.ajax({
                    url: "/api/flights",
                    method: "GET",
                    success: function (data) {
                        flightsData = data;
                        renderFlightsTable(data);
                    },
                    error: function () {
                        console.error("Error fetching flights data.");
                    }
                });
            }

            function renderFlightsTable(data) {
                let tableOfFlights = '<table border="1">';
                tableOfFlights += '<tr><th>Airline</th><th>From</th><th>Destination</th><th>Departure time</th><th>Arrival time</th><th>Available seats</th><th>Booked seats</th><th>Price(RSD)</th><th>Status</th></tr>';

                data.forEach(function (element) {
                    if (element.status == 'Active') {
                        let flight = '<tr>';
                        flight += '<td>' + element.airline.name + '</td>';
                        flight += '<td>' + element.from + '</td>';
                        flight += '<td>' + element.destination + '</td>';
                        flight += '<td>' + new Date(element.departureDateTime).toLocaleString() + '</td>';
                        flight += '<td>' + new Date(element.arrivalDateTime).toLocaleString() + '</td>';
                        flight += '<td>' + element.availableSeats + '</td>';
                        flight += '<td>' + element.bookedSeats + '</td>';
                        flight += '<td>' + element.price + '</td>';
                        flight += '<td>' + element.status + '</td>';
                        flight += '</tr>';
                        tableOfFlights += flight;
                    }
                });

                tableOfFlights += '</table>';
                $('#flights').html(tableOfFlights);
            }
            $('#sortSelect').change(function () {
                let sortBy = $(this).val();

                if (sortBy === 'asc') {
                    flightsData.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                } else if (sortBy === 'desc') {
                    flightsData.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                }

                renderFlightsTable(flightsData);
            });
            $('#searchForm').submit(function (event) {
                event.preventDefault();

                let airlineName = $('#airlineName').val().trim().toLowerCase();
                let from = $('#from').val().trim().toLowerCase();
                let destination = $('#destination').val().trim().toLowerCase();
                let departureDate = $('#departureDate').val();
                let arrivalDate = $('#arrivalDate').val();

                let filteredFlights = flightsData.filter(function (flight) {
                    let matchAirline = airlineName === '' || flight.airline.name.toLowerCase().includes(airlineName);
                    let matchFrom = from === '' || flight.from.toLowerCase().includes(from);
                    let matchDestination = destination === '' || flight.destination.toLowerCase().includes(destination);

                    let matchDepartureDate = true;
                    if (departureDate !== '') {
                        let flightDepartureDate = new Date(flight.departureDateTime).toISOString().split('T')[0];
                        matchDepartureDate = flightDepartureDate === departureDate;
                    }

                    let matchArrivalDate = true;
                    if (arrivalDate !== '') {
                        let flightArrivalDate = new Date(flight.arrivalDateTime).toISOString().split('T')[0];
                        matchArrivalDate = flightArrivalDate === arrivalDate;
                    }

                    return matchAirline && matchFrom && matchDestination && matchDepartureDate && matchArrivalDate && flight.status === 'Active';
                });

                renderFlightsTable(filteredFlights);
            });
        });
    </script>
</head>
<body>
    <div class="menu">
        <a href="Index.html">Flights</a>
        <a href="Airlines.html">Airlines</a>
        <a href="Register.html">Register</a>
        <a href="Login.html">Log in</a>
    </div>
    <br/>
    <h1>Flights</h1>
    <div>
        <form id="searchForm">
            <label>Airline Name:</label>
            <select id="airlineName" style="width:150px"></select>
            <label>From:</label>
            <input type="text" id="from" class="input-field">
            <label>Destination:</label>
            <input type="text" id="destination" class="input-field">
            <label>Departure Date:</label>
            <input type="text" id="departureDate" class="datepicker">
            <label>Arrival Date:</label>
            <input type="text" id="arrivalDate" class="datepicker">
            <input type="submit" value="Search">
        </form>
        <div style="float:right">
        <label>Sort by:</label>
        <select id="sortSelect">
            <option value="asc">Price (Ascending)</option>
            <option value="desc">Price (Descending)</option>
        </select>
    </div>
    </div>
    <br />
    <div id="flights"></div>
    <script>
        $(function () {
            $(".datepicker").datepicker({ dateFormat: 'yy-mm-dd' });
        });
    </script>
</body>
</html>